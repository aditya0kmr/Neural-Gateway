<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>THE CITADEL | Local Debug</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: monospace;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00f3ff;
            color: #fff;
            padding: 20px;
            text-align: center;
            pointer-events: auto;
            cursor: pointer;
        }

        #instructions.hidden {
            display: none;
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00f3ff;
            font-size: 14px;
            text-shadow: 0 0 5px #00f3ff;
        }

        #prompt {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00f3ff;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: bold;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .key {
            border: 1px solid #fff;
            padding: 2px 5px;
            margin: 0 2px;
            font-weight: bold;
        }
    </style>
    <!-- Load Three.js from CDN (No Modules for local file:// access) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/PointerLockControls.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/shaders/CopyShader.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/shaders/LuminosityHighPassShader.js"></script>
</head>

<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="hud">
            <h3>CITADEL // SECTOR 7</h3>
            <p>SYSTEM: ONLINE</p>
        </div>
        <div id="crosshair"></div>
        <div id="prompt">[E] ANALYZE SHARD</div>

        <div id="instructions">
            <h1>NEURAL LINK READY</h1>
            <p>CLICK TO ENGAGE</p>
            <br>
            <p><span class="key">WASD</span> MOVE &nbsp; <span class="key">SPACE</span> JUMP</p>
        </div>

        <!-- NEW: Data Modal -->
        <div id="data-modal"
            style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:400px; background:rgba(0,10,20,0.95); border:1px solid #bc13fe; padding:20px; color:#fff; pointer-events:auto;">
            <h2 style="color:#bc13fe; margin-top:0;">ENCRYPTED SHARD DECODED</h2>
            <p style="color:#ccc; font-size:12px; line-height:1.5;">
                ORIGIN: SECTOR 7<br>
                CONTENTS: NEURAL PATTERN ALPHA<br>
                INTEGRITY: 100%
            </p>
            <div style="margin-top:20px; text-align:right;">
                <button id="close-modal"
                    style="background:#bc13fe; border:none; color:#fff; padding:5px 15px; cursor:pointer;">ACCEPT</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        const state = { locked: false, lastTime: 0, activeTarget: null };
        const interactables = [];

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        scene.fog = new THREE.FogExp2(0x020205, 0.015);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.y = 1.7;

        const renderer = new THREE.WebGLRenderer({ antialias: false }); // Bloom needs false usually for perf
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- POST PROCESSING ---
        // Note: CDN scripts load globally in THREE namespace
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));

        const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.threshold = 0.1;
        bloom.strength = 1.2;
        bloom.radius = 0.5;
        composer.addPass(bloom);

        // --- LIGHTING ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.1));
        const light = new THREE.PointLight(0x00f3ff, 2, 50);
        light.position.set(0, 20, 0);
        scene.add(light);

        // --- WORLD GEN ---
        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(400, 400),
            new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.1, metalness: 0.9 })
        );
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        const grid = new THREE.GridHelper(400, 80, 0x00f3ff, 0x111111);
        scene.add(grid);

        // Towers (Instanced)
        const towerCount = 300;
        const towerGeo = new THREE.BoxGeometry(1, 1, 1);
        const towerMat = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.2, metalness: 0.8 });
        const towers = new THREE.InstancedMesh(towerGeo, towerMat, towerCount);

        const edgeGeo = new THREE.BoxGeometry(1.05, 0.05, 1.05);
        const edgeMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff });
        const edges = new THREE.InstancedMesh(edgeGeo, edgeMat, towerCount);

        const dummy = new THREE.Object3D();

        for (let i = 0; i < towerCount; i++) {
            const x = (Math.random() - 0.5) * 200;
            const z = (Math.random() - 0.5) * 200;
            if (Math.abs(x) < 10 && Math.abs(z) < 10) continue; // Safe zone

            const h = Math.random() * 30 + 5;
            dummy.position.set(x, h / 2, z);
            dummy.scale.set(Math.random() * 5 + 2, h, Math.random() * 5 + 2);
            dummy.updateMatrix();
            towers.setMatrixAt(i, dummy.matrix);

            // Neon ring
            dummy.scale.set(dummy.scale.x, 1, dummy.scale.z);
            dummy.position.y = Math.random() * h;
            dummy.updateMatrix();
            edges.setMatrixAt(i, dummy.matrix);
        }
        scene.add(towers);
        scene.add(edges);

        // Crystals
        const crystalGeo = new THREE.OctahedronGeometry(0.5);
        const crystalMat = new THREE.MeshBasicMaterial({ color: 0xbc13fe });
        for (let i = 0; i < 8; i++) {
            const mesh = new THREE.Mesh(crystalGeo, crystalMat);
            mesh.position.set((Math.random() - 0.5) * 40, 2, (Math.random() - 0.5) * 40);
            if (Math.abs(mesh.position.x) < 5) mesh.position.x += 10;
            scene.add(mesh);
            interactables.push(mesh);
        }

        // --- CONTROLS (FPS) ---
        const controls = new THREE.PointerLockControls(camera, document.body);
        const instructions = document.getElementById('instructions');

        instructions.addEventListener('click', () => controls.lock());
        controls.addEventListener('lock', () => { instructions.classList.add('hidden'); state.locked = true; });
        controls.addEventListener('unlock', () => { instructions.classList.remove('hidden'); state.locked = false; });

        const move = { f: false, b: false, l: false, r: false, jump: false, canJump: false };
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        document.addEventListener('keydown', (e) => {
            switch (e.code) {
                case 'KeyW': move.f = true; break;
                case 'KeyS': move.b = true; break;
                case 'KeyA': move.l = true; break;
                case 'KeyD': move.r = true; break;
                case 'Space': if (move.canJump) { velocity.y += 20; move.canJump = false; } break;
                case 'KeyE':
                    if (state.activeTarget && document.getElementById('data-modal').style.display === 'none') {
                        // OPEN MODAL
                        document.getElementById('data-modal').style.display = 'block';
                        controls.unlock();
                    }
                    break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch (e.code) {
                case 'KeyW': move.f = false; break;
                case 'KeyS': move.b = false; break;
                case 'KeyA': move.l = false; break;
                case 'KeyD': move.r = false; break;
            }
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('data-modal').style.display = 'none';
            controls.lock();
        });

        // --- LOOP ---
        const clock = new THREE.Clock();
        const raycaster = new THREE.Raycaster();
        const prompt = document.getElementById('prompt');

        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);

            if (state.locked) {
                // Physics
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 50.0 * delta; // Gravity

                direction.z = Number(move.f) - Number(move.b);
                direction.x = Number(move.r) - Number(move.l);
                direction.normalize();

                if (move.f || move.b) velocity.z -= direction.z * 100.0 * delta;
                if (move.l || move.r) velocity.x -= direction.x * 100.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                controls.getObject().position.y += velocity.y * delta;

                if (controls.getObject().position.y < 1.7) {
                    velocity.y = 0;
                    controls.getObject().position.y = 1.7;
                    move.canJump = true;
                }

                // Raycast
                raycaster.setFromCamera(new THREE.Vector2(), camera);
                const hits = raycaster.intersectObjects(interactables);
                if (hits.length > 0 && hits[0].distance < 5) {
                    prompt.style.opacity = 1;
                    state.activeTarget = hits[0].object;
                } else {
                    prompt.style.opacity = 0;
                    state.activeTarget = null;
                }
            } else {
                // Idle animation
            }

            // Animate Objects
            const time = Date.now() * 0.001;
            interactables.forEach((obj, i) => {
                obj.rotation.y = time;
                obj.position.y = 2 + Math.sin(time + i) * 0.5;
            });

            composer.render();
        }
        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>